---
id: linux
title: 在Linux上手动安装
sidebar_label: Linux
slug: /installation/linux
description: 在Linux上手动安装或编译本模块的教程。
---

import DarkButton from '@site/src/components/DarkButton';
import IconExternalLink from '@theme/IconExternalLink';
import InlineIcon from '@site/src/components/InlineIcon';
import mdiDownloadBox from '@iconify-icons/mdi/download-box';
import vsiDebugAlt from '@iconify-icons/codicon/debug-alt';
import vsiCheckIcon from '@iconify-icons/codicon/check';
import vsiCloseIcon from '@iconify-icons/codicon/close';
import octMarkGithub16 from '@iconify-icons/octicon/mark-github-16';

本教程包含安装或编译`mpegCoder`的步骤。建议需要在项目里局部部署本模块的用户使用这种方式安装。

## 安装预编译的模块 {#install-the-pre-compiled-module}

### 下载`mpegCoder` {#download-mpegcoder}

首先，用户需要下载本项目的单模块文件。下表提供了下载链接。请根据你的环境选择对应的版本。

| mpegCoder | FFMpeg | Numpy | Python | GCC/G++ | 操作系统 |
| :-----: | :-----: | :-----: | :-----: | :-----: | :-----: |
| [`3.1.0`<InlineIcon icon={mdiDownloadBox}/>][download-3-1-0-py39] | `4.4` | `1.21.1` | `3.9.6` | `8.3.0` | `Debian 10` |
| [`3.1.0`<InlineIcon icon={mdiDownloadBox}/>][download-3-1-0-py38] | `4.4` | `1.21.1` | `3.8.11` | `8.3.0` | `Debian 10` |
| [`3.1.0`<InlineIcon icon={mdiDownloadBox}/>][download-3-1-0-py37] | `4.4` | `1.21.1` | `3.7.11` | `8.3.0` | `Debian 10` |
| [`3.1.0`<InlineIcon icon={mdiDownloadBox}/>][download-3-1-0-py36] | `4.4` | `1.19.5` | `3.6.14` | `8.3.0` | `Debian 10` |
| [`3.1.0`<InlineIcon icon={mdiDownloadBox}/>][download-3-1-0-py35] | `4.4` | `1.18.5` | `3.5.10` | `8.3.0` | `Debian 10` |

解压所下载的taball后，就可以得到`mpegCoder.so`文件。

:::info

上面提到的这些相关项目的版本，只是用来表明预编译`mpegCoder`时所用的环境。这并不代表运行这些预编译的`mpegCoder`必须要依赖这些版本。例如，用户也可以在`python 3.9.5`和`numpy 1.19.5`的环境下运行`mpegCoder`。

:::

### 安装Numpy {#install-numpy}

运行`mpegCoder`之前，必须先安装合适版本的[Numpy<IconExternalLink/>][link-numpy]。每个`mpegCoder`发行版的最佳Numpy版本已经列在上表之中。如果你安装的Numpy版本与所需的最佳版本差距过大，`mpegCoder`可能无法正常运行。以下是安装命令：

```shell
python -m pip install numpy==<version>
```

### 下载依赖项 {#download-dependencies}

在发行页上，我们提供了预编译好的依赖项。这些依赖项包括几个`.so`文件。用户需要根据`mpegCoder`所需的FFMpeg版本，来选择合适的tarball，来下载、并解压文件。

| FFMpeg | GCC/G++ | 操作系统 |
| :-----: | :-----: | :-----: |
| [`4.4`<InlineIcon icon={mdiDownloadBox}/>][download-ff-4-4] | `9.3.0` | Ubuntu `20.04.2` |

这些文件是作者自行编译完成的，因为FFMpeg并没有官方发行在Linux平台上、带有动态库的版本。如果用户有兴趣知道这些依赖项是如何编译出来的，可以参考[编译模块](#compile-the-module)这一小节。

### 导入 {#import}

要导入预编译的`mpegCoder`，用户首先需要将依赖项添加到库路径内。解压出的依赖项文件应该包括以下两个文件夹：

```shell
.
|---lib
`---lib-fix
```

建议将这两个文件存放在某个全局目录下，例如

```shell
/opt/ffmpeg/
|---lib
`---lib-fix
```

此后，用户需要将以下条目添加到`~/.bashrc`。

```shell
export LD_LIBRARY_PATH=/opt/ffmpeg/lib:$LD_LIBRARY_PATH
export PKG_CONFIG_PATH=/opt/ffmpeg/lib/pkgconfig:$PKG_CONFIG_PATH
export PKG_CONFIG_LIBDIR=/opt/ffmpeg/lib/:$PKG_CONFIG_LIBDIR
```

要使得修改过`~/.bashrc`生效，请通过以下方式激活到当前命令行中。

```shell
source ~/.bashrc
```

运行本模块需要安装`glibc>=2.29`。请检查下表，确认你的操作系统是否满足这一条件。

| OS | GLibC | Fulfilled |
| :-----: | :-----: | :-----: |
| Ubuntu bionic (`18.04`) | `2.27` | <InlineIcon icon={vsiCloseIcon}/> |
| Ubuntu focal (`20.04`) | `2.31` | <InlineIcon icon={vsiCheckIcon}/> |
| Debian buster (`10`) | `2.28` | <InlineIcon icon={vsiCloseIcon}/> |
| Debian bullseye (`11`) | `2.31` | <InlineIcon icon={vsiCheckIcon}/> |

如果你的系统没有提供`glibc>=2.29`，则建议自行编译`mpegCoder`。但是，如果用户想要一个快速修复的补丁，可以检查解压后的依赖项文件。

以本文上述的步骤为例，用户可以通过以下方式重定向`/lib`下的GLibC到本项目提供的版本。

```shell
ln -sf /opt/ffmpeg/lib-fix/libm-2.31.so /lib/x86_64-linux-gnu/libm.so.6
```

此后，用户即可通过将`mpegCoder.so`放在项目中，并通过以下命令导入模块。

```python
import mpegCoder
```

## 编译模块 {#compile-the-module}

### 编译`mpegCoder` {#compile-mpegcoder}

如果用户需要自行编译`mpegCoder`，则可以按照以下发布在Github上的指导完成：

<p>
  <DarkButton to="https://github.com/cainmagi/FFmpeg-Encoder-Decoder-for-Python/blob/master-linux/README.md" icon={vsiDebugAlt}>
    使用GCC/G++编译
  </DarkButton>
</p>

### 编译FFMpeg {#compile-ffmpeg}

:::info

本项目不要求用户必须编译FFMpeg，因为`mpegCoder`可以通过加载本页提供的预编译FFMpeg完成编译。然而，在某些情况下，用户需要为某个特定的FFMpeg版本编译`mpegCoder`。

如果用户在使用他们自己的FFMpeg来编译`mpegCoder`, 请参阅安装脚本中的[设置<IconExternalLink/>][code-config]，以及在源文件中的[宏<IconExternalLink/>][code-macros]。

:::

本项目提供了编译FFMpeg的脚本。请检查以下分支：

<p>
  <DarkButton to="https://github.com/cainmagi/FFmpeg-Encoder-Decoder-for-Python/tree/deps" icon={octMarkGithub16}>
    编译脚本
  </DarkButton>
</p>

例如，如果用户想要编译FFMpeg `4.4`，则可以运行

```shell
curl -O https://raw.githubusercontent.com/cainmagi/FFmpeg-Encoder-Decoder-for-Python/deps/install-ffmpeg-4_4.sh
chmod +rwx install-ffmpeg-4_4.sh
./install-ffmpeg-4_4.sh
```

:::info

用户可能需要根据实际情况修改本项目提供的安装脚本，因为该脚本目前只在`Ubuntu 20.04`和`GCC 9.3.0`上测试过。

:::

[download-3-1-0-py39]:https://github.com/cainmagi/FFmpeg-Encoder-Decoder-for-Python/releases/download/3.1.0-linux/mpegCoder_3_1_0_Linux_py39.tar.xz
[download-3-1-0-py38]:https://github.com/cainmagi/FFmpeg-Encoder-Decoder-for-Python/releases/download/3.1.0-linux/mpegCoder_3_1_0_Linux_py38.tar.xz
[download-3-1-0-py37]:https://github.com/cainmagi/FFmpeg-Encoder-Decoder-for-Python/releases/download/3.1.0-linux/mpegCoder_3_1_0_Linux_py37.tar.xz
[download-3-1-0-py36]:https://github.com/cainmagi/FFmpeg-Encoder-Decoder-for-Python/releases/download/3.1.0-linux/mpegCoder_3_1_0_Linux_py36.tar.xz
[download-3-1-0-py35]:https://github.com/cainmagi/FFmpeg-Encoder-Decoder-for-Python/releases/download/3.1.0-linux/mpegCoder_3_1_0_Linux_py35.tar.xz
[download-ff-4-4]:https://github.com/cainmagi/FFmpeg-Encoder-Decoder-for-Python/releases/download/deps-3.0.0/so-linux-ffmpeg_4_4.tar.xz
[code-config]:https://github.com/cainmagi/FFmpeg-Encoder-Decoder-for-Python/blob/master-linux/setup.py#L34
[code-macros]:https://github.com/cainmagi/FFmpeg-Encoder-Decoder-for-Python/blob/master-linux/MpegCoder/MpegBase.h#L11
[link-numpy]:https://numpy.org "Numpy"
